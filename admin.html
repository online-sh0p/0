<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WAVE â€” Admin</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700&family=Syne:wght@400;700;800&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg:      #080808; --surface: #111; --surface2: #161616;
      --border:  #242424; --accent:  #b5ff47; --accent2: #47ffd8;
      --danger:  #ff4757; --warn:    #ffa502; --text: #f0f0f0;
      --muted:   #555; --mono: 'Space Mono', monospace; --head: 'Syne', sans-serif;
    }
    html { scroll-behavior: smooth; }
    body { background: var(--bg); color: var(--text); font-family: var(--head); min-height: 100vh; }

    /* TOPBAR */
    .topbar {
      position: sticky; top: 0; z-index: 50;
      background: rgba(8,8,8,.97); backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      padding: 0 32px; height: 64px;
      display: flex; align-items: center; justify-content: space-between;
    }
    .brand { display: flex; align-items: baseline; gap: 10px; }
    .brand h1 { font-size: 1.5rem; font-weight: 800; letter-spacing: -.03em; }
    .brand h1 span { color: var(--accent); }
    .brand .badge {
      font-family: var(--mono); font-size: .6rem; letter-spacing: .12em;
      color: var(--muted); border: 1px solid var(--border);
      padding: 3px 8px; border-radius: 4px;
    }
    .topbar-right { display: flex; align-items: center; gap: 12px; }
    .pill {
      font-family: var(--mono); font-size: .65rem; letter-spacing: .08em;
      color: var(--accent); background: rgba(181,255,71,.1);
      border: 1px solid rgba(181,255,71,.25); padding: 4px 12px; border-radius: 99px;
    }
    .btn-nav {
      font-family: var(--mono); font-size: .7rem; letter-spacing: .06em;
      color: var(--muted); text-decoration: none;
      padding: 7px 14px; border: 1px solid var(--border); border-radius: 6px;
      transition: all .2s;
    }
    .btn-nav:hover { color: var(--accent); border-color: var(--accent); background: rgba(181,255,71,.06); }

    /* LAYOUT */
    .layout { display: grid; grid-template-columns: 420px 1fr; min-height: calc(100vh - 64px); }

    /* LEFT PANEL */
    .left-panel {
      background: var(--surface); border-right: 1px solid var(--border);
      padding: 28px; position: sticky; top: 64px;
      height: calc(100vh - 64px); overflow-y: auto;
      display: flex; flex-direction: column; gap: 0;
    }

    /* GITHUB CONFIG SECTION */
    .section {
      margin-bottom: 20px; padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }
    .section:last-child { border-bottom: none; }
    .section-title {
      font-family: var(--mono); font-size: .6rem; letter-spacing: .14em;
      color: var(--muted); text-transform: uppercase;
      margin-bottom: 14px; display: flex; align-items: center; gap: 8px;
    }
    .section-title .dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: var(--accent); display: inline-block;
    }
    .github-status {
      display: flex; align-items: center; gap: 8px;
      font-family: var(--mono); font-size: .65rem;
      padding: 8px 12px; border-radius: 6px; margin-bottom: 14px;
      border: 1px solid var(--border); background: var(--surface2);
    }
    .github-status.ok     { border-color: rgba(181,255,71,.3); color: var(--accent); }
    .github-status.warn   { border-color: rgba(255,165,2,.3);  color: var(--warn); }
    .github-status.error  { border-color: rgba(255,71,87,.3);  color: var(--danger); }
    .status-dot { width: 7px; height: 7px; border-radius: 50%; background: currentColor; flex-shrink: 0; }

    /* FIELDS */
    .field { margin-bottom: 16px; }
    .field label {
      display: block; font-family: var(--mono); font-size: .62rem;
      letter-spacing: .1em; color: var(--muted); text-transform: uppercase;
      margin-bottom: 7px;
    }
    .field input[type="text"], .field input[type="password"], .field input[type="url"] {
      width: 100%; background: var(--surface2); border: 1px solid var(--border);
      color: var(--text); font-family: var(--mono); font-size: .78rem;
      padding: 10px 13px; border-radius: 6px; outline: none;
      transition: border-color .2s, box-shadow .2s;
    }
    .field input:focus {
      border-color: rgba(181,255,71,.4);
      box-shadow: 0 0 0 3px rgba(181,255,71,.06);
    }
    .field input::placeholder { color: var(--muted); opacity: .5; }
    .field-hint {
      font-family: var(--mono); font-size: .6rem; color: var(--muted);
      margin-top: 5px; opacity: .65; line-height: 1.5;
    }
    .field-hint a { color: var(--accent); }

    /* DROP ZONE */
    .drop-zone {
      border: 1.5px dashed var(--border); border-radius: 8px;
      padding: 24px 16px; text-align: center; cursor: pointer;
      transition: all .22s; position: relative; background: var(--surface2);
    }
    .drop-zone:hover, .drop-zone.drag-over {
      border-color: var(--accent); background: rgba(181,255,71,.04);
    }
    .drop-zone input[type="file"] {
      position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
    }
    .drop-zone .dz-icon { font-size: 1.6rem; margin-bottom: 8px; display: block; }
    .drop-zone p { font-family: var(--mono); font-size: .68rem; color: var(--muted); line-height: 1.6; }
    .drop-zone .file-name {
      font-family: var(--mono); font-size: .72rem; color: var(--accent);
      margin-top: 8px; word-break: break-all; padding: 0 8px;
    }
    .upload-progress {
      height: 3px; background: var(--border); border-radius: 99px;
      margin-top: 10px; overflow: hidden; display: none;
    }
    .upload-progress-bar {
      height: 100%; background: var(--accent);
      border-radius: 99px; width: 0%; transition: width .3s;
    }

    /* COVER ROW */
    .cover-row { display: grid; grid-template-columns: 68px 1fr; gap: 12px; align-items: center; }
    .cover-thumb {
      width: 68px; height: 68px; border-radius: 8px;
      background: var(--surface2); border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.4rem; overflow: hidden; flex-shrink: 0;
    }
    .cover-thumb img { width: 100%; height: 100%; object-fit: cover; display: none; border-radius: 7px; }

    /* BUTTONS */
    .btn-add {
      width: 100%; background: var(--accent); border: none; color: #000;
      font-family: var(--head); font-size: .9rem; font-weight: 800;
      padding: 13px; border-radius: 8px; cursor: pointer;
      transition: background .2s, transform .15s, box-shadow .2s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .btn-add:hover:not(:disabled) {
      background: var(--accent2); transform: translateY(-1px);
      box-shadow: 0 6px 24px rgba(181,255,71,.25);
    }
    .btn-add:disabled { opacity: .45; cursor: not-allowed; }

    .btn-save-gh {
      width: 100%; background: transparent; border: 1px solid rgba(181,255,71,.3);
      color: var(--accent); font-family: var(--mono); font-size: .7rem;
      letter-spacing: .05em; padding: 10px; border-radius: 6px; cursor: pointer;
      transition: all .2s; margin-top: 8px;
    }
    .btn-save-gh:hover { background: rgba(181,255,71,.08); border-color: var(--accent); }

    /* RIGHT PANEL â€” library */
    .right-panel { padding: 28px 32px 80px; }
    .lib-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 18px; padding-bottom: 14px; border-bottom: 1px solid var(--border);
    }
    .lib-title { font-family: var(--mono); font-size: .62rem; letter-spacing: .14em; color: var(--muted); text-transform: uppercase; }
    .btn-danger-sm {
      font-family: var(--mono); font-size: .62rem; letter-spacing: .07em;
      color: var(--danger); background: transparent;
      border: 1px solid rgba(255,71,87,.22); padding: 5px 12px;
      border-radius: 5px; cursor: pointer; transition: all .2s; opacity: .6;
    }
    .btn-danger-sm:hover { opacity: 1; background: rgba(255,71,87,.07); }

    /* Song cards */
    .cards { display: flex; flex-direction: column; gap: 10px; }
    .card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
      padding: 14px 16px; display: grid;
      grid-template-columns: 50px 1fr auto; gap: 14px; align-items: center;
      animation: slide-in .28s ease;
    }
    @keyframes slide-in { from { opacity:0; transform:translateY(-6px); } to { opacity:1; transform:none; } }
    .card:hover { border-color: rgba(181,255,71,.18); background: var(--surface2); }
    .card-art {
      width: 50px; height: 50px; border-radius: 6px;
      background: var(--surface2); border: 1px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      font-size: 1.1rem; overflow: hidden; flex-shrink: 0;
    }
    .card-art img { width:100%; height:100%; object-fit:cover; border-radius:5px; }
    .card-info { min-width: 0; }
    .card-title { font-size: .88rem; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 2px; }
    .card-meta { font-family: var(--mono); font-size: .62rem; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .card-file { font-family: var(--mono); font-size: .58rem; color: rgba(181,255,71,.45); margin-top: 3px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .card-gh-badge {
      font-family: var(--mono); font-size: .55rem; padding: 2px 6px;
      border-radius: 3px; margin-left: 6px; display: inline-block;
    }
    .badge-uploaded { background: rgba(181,255,71,.15); color: var(--accent); }
    .badge-local    { background: rgba(255,165,2,.12);  color: var(--warn); }
    .card-actions { display: flex; gap: 6px; flex-shrink: 0; }
    .btn-del {
      background: transparent; border: 1px solid var(--border);
      color: var(--muted); width: 32px; height: 32px; border-radius: 6px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all .2s;
    }
    .btn-del:hover { border-color: var(--danger); color: var(--danger); background: rgba(255,71,87,.07); }

    /* Empty */
    .empty {
      text-align: center; padding: 70px 40px;
      border: 1.5px dashed var(--border); border-radius: 12px;
    }
    .empty .e-icon { font-size: 2.8rem; margin-bottom: 14px; display: block; }
    .empty h3 { font-size: .95rem; font-weight: 700; margin-bottom: 8px; }
    .empty p { font-family: var(--mono); font-size: .68rem; color: var(--muted); line-height: 1.8; }

    /* TOAST */
    #toast {
      position: fixed; bottom: 26px; right: 26px;
      background: var(--surface2); border: 1px solid var(--border);
      color: var(--text); font-family: var(--mono); font-size: .72rem;
      padding: 10px 18px; border-radius: 6px;
      opacity: 0; transform: translateY(8px);
      transition: opacity .25s, transform .25s;
      z-index: 9999; pointer-events: none; max-width: 340px;
    }
    #toast.show    { opacity: 1; transform: translateY(0); }
    #toast.success { border-color: rgba(181,255,71,.4); color: var(--accent); }
    #toast.error   { border-color: rgba(255,71,87,.4);  color: var(--danger); }
    #toast.warn    { border-color: rgba(255,165,2,.4);  color: var(--warn); }

    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: var(--bg); }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 99px; }

    @media (max-width: 860px) {
      .layout { grid-template-columns: 1fr; }
      .left-panel { position: static; height: auto; border-right: none; border-bottom: 1px solid var(--border); }
    }
  </style>
</head>
<body>

<header class="topbar">
  <div class="brand">
    <h1>W<span>A</span>VE</h1>
    <span class="badge">Admin</span>
  </div>
  <div class="topbar-right">
    <span class="pill" id="count-pill">0 tracks</span>
    <a href="index.html" class="btn-nav">â† Open Player</a>
  </div>
</header>

<div class="layout">

  <!-- â”€â”€ LEFT: Form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <aside class="left-panel">

    <!-- GitHub Config -->
    <div class="section">
      <div class="section-title"><span class="dot"></span> GitHub Config</div>
      <div class="github-status warn" id="gh-status">
        <span class="status-dot"></span>
        <span id="gh-status-text">Enter your GitHub details below</span>
      </div>

      <div class="field">
        <label>Personal Access Token</label>
        <input type="password" id="gh-token" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" autocomplete="off">
        <div class="field-hint">
          Needs <strong>Contents: read & write</strong> scope.<br>
          <a href="https://github.com/settings/tokens/new" target="_blank">Create token at github.com/settings/tokens â†’</a>
        </div>
      </div>
      <div class="field">
        <label>Repository (owner/repo)</label>
        <input type="text" id="gh-repo" placeholder="username/my-music-app">
      </div>
      <div class="field">
        <label>Branch</label>
        <input type="text" id="gh-branch" placeholder="main">
      </div>
      <div class="field">
        <label>MP3 folder in repo</label>
        <input type="text" id="gh-folder" placeholder="music">
        <div class="field-hint">Leave blank to upload to root. e.g. "music" â†’ uploads to /music/song.mp3</div>
      </div>
      <button class="btn-save-gh" id="btn-save-gh">Save GitHub Config</button>
    </div>

    <!-- Add Track -->
    <div class="section">
      <div class="section-title"><span class="dot"></span> Add Track</div>

      <div class="field">
        <label>MP3 File</label>
        <div class="drop-zone" id="drop-zone">
          <input type="file" id="input-mp3" accept=".mp3,audio/mpeg">
          <span class="dz-icon">ğŸµ</span>
          <p>Drop MP3 here or click to browse</p>
          <div class="file-name" id="mp3-name"></div>
          <div class="upload-progress" id="upload-progress">
            <div class="upload-progress-bar" id="upload-bar"></div>
          </div>
        </div>
      </div>

      <div class="field">
        <label>Track Title</label>
        <input type="text" id="input-title" placeholder="e.g. Neon Drift">
      </div>
      <div class="field">
        <label>Artist</label>
        <input type="text" id="input-artist" placeholder="e.g. Synthwave Archive">
      </div>
      <div class="field">
        <label>Album</label>
        <input type="text" id="input-album" placeholder="e.g. City Lights">
      </div>
      <div class="field">
        <label>Duration</label>
        <input type="text" id="input-duration" placeholder="3:42" maxlength="7">
        <div class="field-hint">Auto-detected from file. Override if needed.</div>
      </div>

      <div class="field">
        <label>Cover Art (optional)</label>
        <div class="cover-row">
          <div class="cover-thumb" id="cover-thumb">ğŸ¨<img id="cover-img" src="" alt=""></div>
          <div class="drop-zone" style="padding:14px 10px">
            <input type="file" id="input-cover" accept="image/*">
            <p style="font-size:.62rem">Click to choose<br>JPG Â· PNG Â· WEBP</p>
          </div>
        </div>
      </div>

      <button class="btn-add" id="btn-add">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Upload to GitHub &amp; Add Track
      </button>
    </div>

  </aside>

  <!-- â”€â”€ RIGHT: Library â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <main class="right-panel">
    <div class="lib-header">
      <div class="lib-title">// Track Library</div>
      <button class="btn-danger-sm" id="btn-clear">Clear All</button>
    </div>
    <div class="cards" id="cards"></div>
  </main>
</div>

<div id="toast"></div>

<script>
const STORAGE_KEY = 'wave_songs';
const GH_CFG_KEY  = 'wave_gh_config';

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let songs    = loadSongs();
let mp3File  = null;
let coverB64 = null;

// â”€â”€ PERSISTENCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadSongs() {
  try { return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; } catch { return []; }
}
function saveSongs() { localStorage.setItem(STORAGE_KEY, JSON.stringify(songs)); }

function loadGhConfig() {
  try { return JSON.parse(localStorage.getItem(GH_CFG_KEY)) || {}; } catch { return {}; }
}
function saveGhConfig(cfg) { localStorage.setItem(GH_CFG_KEY, JSON.stringify(cfg)); }

// â”€â”€ GITHUB CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const ghFields = {
  token:  document.getElementById('gh-token'),
  repo:   document.getElementById('gh-repo'),
  branch: document.getElementById('gh-branch'),
  folder: document.getElementById('gh-folder'),
};

function fillGhFields() {
  const cfg = loadGhConfig();
  if (cfg.token)  ghFields.token.value  = cfg.token;
  if (cfg.repo)   ghFields.repo.value   = cfg.repo;
  if (cfg.branch) ghFields.branch.value = cfg.branch;
  if (cfg.folder !== undefined) ghFields.folder.value = cfg.folder;
  updateGhStatus();
}

function updateGhStatus() {
  const cfg  = loadGhConfig();
  const el   = document.getElementById('gh-status');
  const text = document.getElementById('gh-status-text');
  if (cfg.token && cfg.repo) {
    el.className   = 'github-status ok';
    text.textContent = 'âœ“ Connected to ' + cfg.repo + ' (' + (cfg.branch || 'main') + ')';
  } else {
    el.className   = 'github-status warn';
    text.textContent = 'Enter your GitHub details to enable auto-upload';
  }
}

document.getElementById('btn-save-gh').addEventListener('click', () => {
  const cfg = {
    token:  ghFields.token.value.trim(),
    repo:   ghFields.repo.value.trim(),
    branch: ghFields.branch.value.trim() || 'main',
    folder: ghFields.folder.value.trim(),
  };
  if (!cfg.token || !cfg.repo) { toast('Token and repo are required', 'error'); return; }
  saveGhConfig(cfg);
  updateGhStatus();
  toast('GitHub config saved âœ“', 'success');
});

// â”€â”€ UPLOAD TO GITHUB API â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function uploadToGitHub(file, cfg) {
  const folder   = cfg.folder ? cfg.folder.replace(/^\/|\/$/g, '') + '/' : '';
  const filePath = folder + file.name;
  const apiUrl   = `https://api.github.com/repos/${cfg.repo}/contents/${filePath}`;

  // Read file as base64
  const b64 = await fileToBase64(file);

  // Check if file already exists (need its SHA to update)
  let sha;
  try {
    const check = await fetch(apiUrl, {
      headers: { Authorization: 'token ' + cfg.token, Accept: 'application/vnd.github+json' }
    });
    if (check.ok) {
      const existing = await check.json();
      sha = existing.sha;
    }
  } catch (_) {}

  const body = {
    message: `Add ${file.name} via WAVE Admin`,
    content: b64,
    branch:  cfg.branch || 'main',
  };
  if (sha) body.sha = sha;  // required for updates

  const res = await fetch(apiUrl, {
    method:  'PUT',
    headers: {
      Authorization:  'token ' + cfg.token,
      Accept:         'application/vnd.github+json',
      'Content-Type': 'application/json',
    },
    body: JSON.stringify(body),
  });

  if (!res.ok) {
    const err = await res.json().catch(() => ({}));
    throw new Error(err.message || 'GitHub API error ' + res.status);
  }

  // Return the raw URL to use as src
  const folder_prefix = cfg.folder ? cfg.folder.replace(/^\/|\/$/g, '') + '/' : '';
  return folder_prefix + file.name;
}

function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload  = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

// â”€â”€ MP3 FILE INPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const inputMp3 = document.getElementById('input-mp3');
const dropZone = document.getElementById('drop-zone');

function handleMp3(file) {
  if (!file || file.type !== 'audio/mpeg') { toast('Please select an MP3 file', 'error'); return; }
  mp3File = file;
  document.getElementById('mp3-name').textContent = file.name;

  // Auto-fill title
  const titleEl = document.getElementById('input-title');
  if (!titleEl.value) {
    titleEl.value = file.name.replace(/\.mp3$/i, '').replace(/[-_]/g, ' ').trim();
  }

  // Auto-detect duration
  const durEl = document.getElementById('input-duration');
  if (!durEl.value) {
    const url = URL.createObjectURL(file);
    const tmp = new Audio(url);
    tmp.addEventListener('loadedmetadata', () => {
      const total = Math.floor(tmp.duration);
      const m = Math.floor(total / 60);
      const s = String(total % 60).padStart(2, '0');
      durEl.value = `${m}:${s}`;
      URL.revokeObjectURL(url);
    });
  }
}

inputMp3.addEventListener('change', () => handleMp3(inputMp3.files[0]));

dropZone.addEventListener('dragover',  e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
dropZone.addEventListener('dragleave', ()  => dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('drag-over');
  handleMp3(e.dataTransfer.files[0]);
});

// â”€â”€ COVER INPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('input-cover').addEventListener('change', function () {
  const file = this.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    coverB64 = e.target.result;
    const img = document.getElementById('cover-img');
    img.src   = coverB64;
    img.style.display = 'block';
    const thumb = document.getElementById('cover-thumb');
    thumb.textContent = '';
    thumb.appendChild(img);
  };
  reader.readAsDataURL(file);
});

// â”€â”€ ADD TRACK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('btn-add').addEventListener('click', async () => {
  const title    = document.getElementById('input-title').value.trim();
  const artist   = document.getElementById('input-artist').value.trim();
  const album    = document.getElementById('input-album').value.trim();
  const duration = document.getElementById('input-duration').value.trim();

  if (!mp3File) { toast('Select an MP3 file first', 'error'); return; }
  if (!title)   { toast('Track title is required', 'error'); return; }
  if (!artist)  { toast('Artist name is required', 'error'); return; }

  const cfg = loadGhConfig();
  const btn = document.getElementById('btn-add');
  btn.disabled = true;

  let src      = mp3File.name;   // fallback: just filename
  let uploaded = false;

  if (cfg.token && cfg.repo) {
    // Show progress animation
    const prog = document.getElementById('upload-progress');
    const bar  = document.getElementById('upload-bar');
    prog.style.display = 'block';
    // Fake progress while uploading
    let pct = 0;
    const ticker = setInterval(() => {
      pct = Math.min(pct + 4, 88);
      bar.style.width = pct + '%';
    }, 120);

    try {
      src      = await uploadToGitHub(mp3File, cfg);
      uploaded = true;
      clearInterval(ticker);
      bar.style.width = '100%';
      await delay(400);
      prog.style.display = 'block';
    } catch (err) {
      clearInterval(ticker);
      prog.style.display = 'none';
      toast('GitHub upload failed: ' + err.message, 'error');
      btn.disabled = false;
      return;
    }
  } else {
    toast('No GitHub config â€” saving filename only. Add config above to auto-upload.', 'warn');
  }

  const song = {
    title,
    artist,
    album:    album || 'Unknown Album',
    src,
    cover:    coverB64 || '',
    duration: duration || 'â€”',
    uploaded,
    addedAt:  Date.now(),
  };

  songs.push(song);
  saveSongs();
  renderCards();
  resetForm();
  btn.disabled = false;
  toast(uploaded ? 'âœ“ Uploaded to GitHub & added to library' : 'âœ“ Added to library (no GitHub upload)', 'success');
});

// â”€â”€ CLEAR ALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('btn-clear').addEventListener('click', () => {
  if (!songs.length) return;
  if (!confirm('Remove all tracks from the library?')) return;
  songs = [];
  saveSongs();
  renderCards();
  toast('Library cleared', 'error');
});

// â”€â”€ RENDER CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCards() {
  const el   = document.getElementById('cards');
  const pill = document.getElementById('count-pill');
  pill.textContent = songs.length + ' track' + (songs.length !== 1 ? 's' : '');

  if (!songs.length) {
    el.innerHTML = `
      <div class="empty">
        <span class="e-icon">ğŸ›ï¸</span>
        <h3>No tracks yet</h3>
        <p>Upload an MP3 using the form on the left.<br>
           Make sure your GitHub config is set so<br>
           files are pushed to your repo automatically.</p>
      </div>`;
    return;
  }

  el.innerHTML = songs.map((s, i) => `
    <div class="card">
      <div class="card-art">
        ${s.cover ? `<img src="${esc(s.cover)}" alt="">` : 'ğŸµ'}
      </div>
      <div class="card-info">
        <div class="card-title">${esc(s.title)}</div>
        <div class="card-meta">
          ${esc(s.artist)} Â· ${esc(s.album)} Â· ${esc(s.duration || 'â€”')}
        </div>
        <div class="card-file">
          ğŸ“ ${esc(s.src)}
          <span class="card-gh-badge ${s.uploaded ? 'badge-uploaded' : 'badge-local'}">
            ${s.uploaded ? 'âœ“ GitHub' : 'âš  local only'}
          </span>
        </div>
      </div>
      <div class="card-actions">
        <button class="btn-del" onclick="removeSong(${i})" title="Remove">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round">
            <polyline points="3 6 5 6 21 6"/>
            <path d="M19 6l-1 14H6L5 6"/><path d="M10 11v6M14 11v6"/>
            <path d="M9 6V4h6v2"/>
          </svg>
        </button>
      </div>
    </div>
  `).join('');
}

function removeSong(i) {
  const name = songs[i].title;
  songs.splice(i, 1);
  saveSongs();
  renderCards();
  toast('Removed: ' + name, 'error');
}

// â”€â”€ RESET FORM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function resetForm() {
  mp3File = null; coverB64 = null;
  document.getElementById('mp3-name').textContent = '';
  document.getElementById('input-mp3').value      = '';
  document.getElementById('input-title').value    = '';
  document.getElementById('input-artist').value   = '';
  document.getElementById('input-album').value    = '';
  document.getElementById('input-duration').value = '';
  document.getElementById('input-cover').value    = '';
  document.getElementById('upload-progress').style.display = 'none';
  document.getElementById('upload-bar').style.width = '0%';
  const img = document.getElementById('cover-img');
  img.src = ''; img.style.display = 'none';
  const thumb = document.getElementById('cover-thumb');
  thumb.textContent = 'ğŸ¨';
  thumb.appendChild(img);
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

let _tt;
function toast(msg, type = '') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'show ' + type;
  clearTimeout(_tt);
  _tt = setTimeout(() => { el.className = ''; }, 3200);
}

function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
fillGhFields();
renderCards();
</script>
</body>
</html>
